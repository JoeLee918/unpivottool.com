# 虚拟合并与空单元格交互 - 问题分析与解决方案（2025-08-08）

## 背景
- 首页与 Unmerge 工具需要统一“合并单元格”的体验：粘贴/上传后保持外观，转换/处理时拆分并填充“因合并导致的空白”，真实空白保留。
- 粘贴来源（Excel→浏览器）默认不会携带真实合并范围；上传 .xlsx 才能通过 SheetJS 读取 `!merges`。
- 之前实现存在：Step1 合并占位样式干扰视觉；Step2 不可重复刷新；粘贴后未立即填充；空单元格/空格的语义不一致。

## 目标
1. 粘贴/上传后立即展开合并，仅填“严格空”导致的空白。
2. 去掉占位水印，保持编辑视觉干净。
3. 统一“空单元格”定义为严格空字符串 `''`（不 trim）。空格/制表符/nbsp 视为有效内容。
4. Step1、Full Editor、Step3 统一“标黄空单元格”交互，仅对严格空高亮；按钮仅在存在严格空时可用。
5. Step3 输出保留空单元格与空格，不吞不填。

## 方案设计
- 虚拟合并模型
  - 粘贴：优先解析 clipboard `text/html` 的 `<table>`（读取 `rowSpan/colSpan`）；回退解析 TSV。
  - 上传：SheetJS 读取 `worksheet['!merges']`，生成统一的 `merges`。
  - 渲染：保持普通表格；需要时仅加无视觉的标记类，不使用真实 `rowspan/colspan`；编辑稳定。
  - 转换：`expandMergesForConvert({matrix, merges}, {keepTrueBlank:true})` 仅填严格空。

- 空单元格与空格
  - 所有“空”判断统一为 `cell === ''`；彻底移除 `.trim()`；`cleanCell` 仅去除包裹引号。
  - `extractTableData` 不再 trim，确保用户输入空格保留；Step3 展示/导出均保留。

- 标黄交互
  - Step1：`#toggle-empty-highlight` 作用于 `#data-grid`。
  - Full Editor：`#modal-highlight-empty` 作用于 `#large-grid`。
  - Step3：`#highlight-results` 作用于 `#results-table table`；Edit Results 复用浮框按钮。
  - 若无严格空，点击弹出提示 `No empty cells to highlight.`。

## 关键改动（摘要）
- `app.js`
  - 粘贴/上传后立即 `expandMergesForConvert`。
  - `detectMergedGroups`、`expandMergesForConvert`、`extractTableData`、`displayResults` 全线改为严格空判断；移除 trim。
  - 统一 `toggleEmptyHighlight(selector)`，三处复用；无空时提示。
- `styles.css`
  - 移除合并水印视觉；新增 `.empty-cell`（浅黄背景 + 虚线边框）。
- `index.html`
  - 新增按钮：Step1、Full Editor、Step3 的 `Highlight Empty Cells`。

## 已知边界
- 粘贴为纯文本时，无法获得真实合并范围，仅能做启发式；上传 .xlsx 可 100% 还原合并。
- CSV 无法携带样式；按性能要求，下载 XLSX 不做样式标黄。

## 验收要点
- 粘贴含合并表：NGB/Grand total 等横向合并应被立刻右向补齐；含空格的格子不被覆盖。
- 点击三个位置的 “Highlight Empty Cells”：仅严格空被高亮；空格不高亮；无严格空弹提示。
- Step3 输出能看见真正空单元格（空字符串），空格原样保留。


